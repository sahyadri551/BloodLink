rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- RULES FOR 'users' ---
    match /users/{userId} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == userId;

      // Allow update IF:
      // 1. You are the owner
      // OR
      // 2. Your UID exists as a document in the 'admins' collection
      allow update: if request.auth != null && 
                      (request.auth.uid == userId ||
                       exists(/databases/(database)/documents/admins/$(request.auth.uid)));

      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // --- LOCK DOWN THE 'admins' COLLECTION ---
    match /admins/{adminId} {
      // Nobody can read or write this from the client
      allow read, write: if false; 
    }

    // --- RULES FOR 'verifiedHospitals' ---
    match /verifiedHospitals/{hospitalId} {
      // Allow create IF the user is an admin
      allow create: if request.auth != null &&
                      exists(/databases/(database)/documents/admins/$(request.auth.uid));

      allow read, update, delete: if false;
    }

    // --- 'bloodRequests' ---
    match /bloodRequests/{requestId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.uid;
    }

    // --- 'bloodCamps' ---
    match /bloodCamps/{campId} {
      allow read: if true;

      // Check the 'verifiedHospitals' collection
      allow create: if request.auth != null 
                    && exists(/databases/(database)/documents/verifiedHospitals/$(request.auth.uid));

      allow update, delete: if request.auth != null && request.auth.uid == resource.data.hospitalId;
    }

    // --- THIS IS THE NEW FIX for 'blogPosts' ---
    match /blogPosts/{postId} {
      // ANYONE (logged in or out) can READ blog posts
      allow read: if true;

      // Only an ADMIN (whose UID exists in 'admins') can CREATE
      allow create: if request.auth != null &&
                      exists(/databases/(database)/documents/admins/$(request.auth.uid));

      // Only an ADMIN can UPDATE or DELETE
      allow update, delete: if request.auth != null &&
                             exists(/databases/(database)/documents/admins/$(request.auth.uid));
    }

  }
}